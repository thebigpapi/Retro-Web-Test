{% extends '@!EasyAdmin/crud/form_theme.html.twig' %}

{# added the flashy triangle #}
{% block form_errors %}
{% if attr.class|default('') == 'global-invalid-feedback'%}
    <div class="editor-errors">
        <img src="{{ absolute_url(asset('build/icons/warning.svg')) }}" alt="warning" width="40" height="40">
        <div>
        {% if errors|length > 0 %}
            {% for error in errors %}
                <div class="{{ attr.class|default('') }} invalid-feedback d-block">{{ error.message }}</div>
            {% endfor %}
        {% endif %}
        </div>
    </div>
{% else %}
    {% if errors|length > 0 %}
        {% for error in errors %}
            <div class="{{ attr.class|default('') }} invalid-feedback d-block">{{ error.message }}</div>
        {% endfor %}
    {% endif %}
{% endif %}
{% endblock form_errors %}

{# relocated add widget button, added IDs for sockets #}
{% block collection_widget %}
    {# the "is iterable" check is needed because if an object implements __toString() and
               returns an empty string, "is empty" returns true even if it's not a collection #}
    {% set isEmptyCollection = value is null or (value is iterable and value is empty) %}
    {% set is_array_field = 'EasyCorp\\Bundle\\EasyAdminBundle\\Field\\ArrayField' == form.vars.ea_crud_form.ea_field.fieldFqcn ?? false %}
    {% if allow_add|default(false) and not disabled %}
        <button type="button" class="btn btn-link field-collection-add-button">
            <i class="fa fa-plus pr-1"></i>
            {{ 'action.add_new_item'|trans({}, 'EasyAdminBundle') }}
        </button>
    {% endif %}
    <div class="ea-form-collection-items" id="{{id}}_collection">
        {% if isEmptyCollection %}
            {{ block('empty_collection') }}
        {% elseif is_array_field %}
            {{ block('form_widget') }}
        {% else %}
            <div class="accordion">
                {{ block('form_widget') }}
            </div>
        {% endif %}
    </div>

    {% if isEmptyCollection or form.vars.prototype is defined %}
        {% set attr = attr|merge({'data-empty-collection': block('empty_collection') }) %}
    {% endif %}
{% endblock collection_widget %}

{# delete button tweaks, removed accordion #}
{% block collection_entry_row %}
    {% set is_array_field = 'EasyCorp\\Bundle\\EasyAdminBundle\\Field\\ArrayField' == form_parent(form).vars.ea_crud_form.ea_field.fieldFqcn ?? false %}
    {% set is_complex = form_parent(form).vars.ea_crud_form.ea_field.customOptions.get('entryIsComplex') ?? false %}
    {% set allows_deleting_items = form_parent(form).vars.allow_delete|default(false) %}
    {% set render_expanded = form_parent(form).vars.ea_crud_form.ea_field.customOptions.get('renderExpanded') ?? false %}
    {% set delete_item_button %}
        <button id="{{ id }}_deletebtn" type="button" class="btn btn-link btn-link-danger field-collection-delete-button"
                style="position:relative;"
                title="{{ 'action.remove_item'|trans({}, 'EasyAdminBundle') }}">
            <i class="far fa-trash-alt"></i>
        </button>
    {% endset %}
    <div class="field-collection-item {{ is_complex ? 'field-collection-item-complex' }}">
        {% if is_array_field|default(false) %}
            {{ form_widget(form) }}
            {% if allows_deleting_items and not disabled %}
                {{ delete_item_button }}
            {% endif %}
        {% else %}
            <div class="accordion-item">
                <div id="{{ id }}-contents" class="accordion-collapse collapse {{ render_expanded ? 'show' }}">
                    <div class="accordion-body trw">
                        <div class="accordion-body-widget">{{ form_widget(form) }}</div>
                        <div class="accordion-body-delete-btn">{% if allows_deleting_items and not disabled %}
                            {{ delete_item_button }}
                        {% endif %}</div>
                    </div>
                </div>
                <button class="accordion-button {{ render_expanded ? '' : 'collapsed' }}" style="width:0;display:none;" type="button" data-bs-toggle="collapse" data-bs-target="#{{ id }}-contents">
                        <i class="fas fw fa-chevron-right form-collection-item-collapse-marker"></i>
                        {{ value|ea_as_string }}
                </button>
            </div>
        {% endif %}
    </div>
{% endblock collection_entry_row %}

{# some customizations for the upload field #}
{% block vich_file_widget %}
    <div class="ea-vich-file">
        {% set file_upload_js %}
            var newFile = document.getElementById('{{ form.file.vars.id }}').files[0];
            var fileSizeInMegabytes = newFile.size > 1024 * 1024;
            var fileSize = fileSizeInMegabytes ? newFile.size / (1024 * 1024) : newFile.size / 1024;
            document.getElementById('{{ form.file.vars.id }}_new_file_name').innerText = newFile.name + ' (' + fileSize.toFixed(2) + ' ' + (fileSizeInMegabytes ? 'MB' : 'KB') + ')';
        {% endset %}
        <div class="vich-download-flex">
            <div class="row-flex">
            <div class="ea-vich-file-actions">
                {# the container element is needed to allow customizing the <input type="file" /> #}
                <div class="btn btn-secondary input-file-container">
                    <i class="fa fa-fw fa-upload"></i> {{ 'action.choose_file'|trans({}, 'EasyAdminBundle') }}
                    {{ form_widget(form.file, { 'attr': { 'onchange': file_upload_js }, vich: true}) }}
                </div>

                {% if form.delete is defined %}
                    {{ form_row(form.delete) }}
                {% endif %}
            </div>
            {% if download_uri|default('') is not empty %}
                {% set file_extension = download_uri|split('.')|last %}
                {% set extension_icons = {
                    'gif': 'fa-file-image-o',
                    'jpg': 'fa-file-image-o',
                    'pdf': 'fa-file-pdf-o',
                    'png': 'fa-file-image-o',
                    'zip': 'fa-file-archive-o'
                } %}
                <a id="{{ form.file.vars.id }}_link" class="ea-vich-file-name" href="{{ asset_helper is same as(true) ? asset(download_uri) : download_uri }}" title="{{ download_uri|split('/')|last ?: 'download'|trans({}, 'VichUploaderBundle') }}">
                    <img src="{{ absolute_url(asset('build/icons/dw.svg')) }}" alt="" width="16" height="16" style="vertical-align: middle;">
                    {%- if download_label|default(false) -%}
                        {{ ' ' ~ download_uri|split('/')|last ?: 'download'|trans({}, 'VichUploaderBundle') }}
                    {%- else -%}
                        {{ ' Download'|trans }}
                    {%- endif -%}
                </a>
            {% endif %}
            </div>
            <div class="small" id="{{ form.file.vars.id }}_new_file_name"></div>
        </div>
    </div>
{% endblock %}

{# tweaked thumbnails #}
{% block vich_image_widget %}
    {% set formTypeOptions = ea_crud_form.ea_field.formTypeOptions|default('') %}
    <div class="ea-vich-image">
        {% if image_uri|default('') is not empty %}
            {% if download_uri|default('') is empty %}
                <div class="ea-lightbox-thumbnail">
                    {% if image_uri ends with '.svg' %}
                        <img style="cursor: initial" src="{{ asset_helper is same as(true) ? asset(image_uri) : image_uri }}">
                    {% else %}
                        <img style="cursor: initial" src="{{ (asset_helper is same as(true) ? asset(image_uri) : image_uri)|ea_apply_filter_if_exists('imagine_filter','show_thumb') }}">
                    {% endif %}
                </div>
            {% else %}
                {% set _lightbox_id = 'ea-lightbox-' ~ id %}
                <a href="{{ asset_helper is same as(true) ? asset(download_uri) : download_uri }}" class="ea-lightbox-thumbnail glightbox" data-ea-lightbox-content-selector="#{{ _lightbox_id }}">
                    {% if download_uri ends with '.svg' %}
                        <img src="{{ asset_helper is same as(true) ? asset(download_uri) : download_uri }}">
                    {% else %}
                        <img src="{{ (asset_helper is same as(true) ? asset(download_uri) : download_uri)|ea_apply_filter_if_exists('imagine_filter','show_thumb') }}">
                    {% endif %}
                </a>
            {% endif %}
        {% endif %}

        {% set file_upload_js %}
            var newFile = document.getElementById('{{ form.file.vars.id }}').files[0];
            var fileSizeInMegabytes = newFile.size > 1024 * 1024;
            var fileSize = fileSizeInMegabytes ? newFile.size / (1024 * 1024) : newFile.size / 1024;
            document.getElementById('{{ form.file.vars.id }}_new_file_name').innerText = newFile.name + ' (' + fileSize.toFixed(2) + ' ' + (fileSizeInMegabytes ? 'MB' : 'KB') + ')';
        {% endset %}

        <div class="ea-vich-image-actions">
            {# the container element is needed to allow customizing the <input type="file" /> #}
            <div class="btn btn-secondary input-file-container">
                <i class="fa fa-fw fa-upload"></i> {{ 'action.choose_file'|trans({}, 'EasyAdminBundle') }}
                {{ form_widget(form.file, { 'attr': { 'onchange': file_upload_js }, vich: true}) }}
            </div>

            {% if form.delete is defined %}
                {{ form_row(form.delete) }}
            {% endif %}
        </div>
        <div class="small" id="{{ form.file.vars.id }}_new_file_name"></div>
    </div>
{% endblock %}

{% block ea_crud_widget %}
    {% if ea_crud_form.form_tabs|length > 0 %}
        <div class="col-12">
            <div class="nav-tabs-custom form-tabs">
                <ul class="nav nav-tabs">
                    {% for tab_name, tab_config in ea_crud_form.form_tabs %}
                        <li class="nav-item">
                            <a class="nav-link {% if tab_config.active %}active{% endif %}" href="#{{ tab_config['id'] }}" id="{{ tab_config['id'] }}-tab" data-bs-toggle="tab">
                                {%- if tab_config.icon|default(false) -%}
                                    <i class="fa-fw {{ tab_config.icon }}"></i>
                                {%- endif -%}
                                {{ tab_config['label']|trans(domain = ea.i18n.translationDomain) }}
                                {%- if tab_config.errors > 0 -%}
                                    <span class="badge badge-danger" title="{{ 'form.tab.error_badge_title'|trans({'%count%': tab_config.errors}, 'EasyAdminBundle') }}">
                                        {{- tab_config.errors -}}
                                    </span>
                                {%- endif -%}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
                <div class="tab-content">
                    {% for tab_name, tab_config in ea_crud_form.form_tabs %}
                        <div id="{{ tab_config['id'] }}" class="tab-pane {% if tab_config.active %}active{% endif %} {{ tab_config['css_class']|default('') }}">
                            {% if tab_config['help']|default(false) %}
                                <div class="content-header-help tab-help">
                                    {{ tab_config['help']|trans(domain = ea.i18n.translationDomain)|raw }}
                                </div>
                            {% endif %}

                            <div class="row">
                                {% if tab_name is defined and tab_name %}
                                    {% macro recursiveTabForm(form, ea_crud_form, tab_name) %}
                                        {% for field in form|filter(field => not ea_crud_form.form_panels|filter((panel_config, form_panel) => form_panel == field.vars.ea_crud_form.form_panel) and ((field.vars.ea_crud_form.form_tab is defined and field.vars.ea_crud_form.form_tab == tab_name) or field.vars.ea_crud_form.form_tabs is defined)) %}
                                            {% if field.vars.ea_crud_form.form_tabs is defined %}
                                                {# If the field is a nested CRUD form then only render its children #}
                                                {{ _self.recursiveTabForm(field, ea_crud_form, tab_name) }}
                                            {% else %}
                                                {# Render all other fields #}
                                                {{ form_row(field) }}
                                            {% endif %}
                                        {% endfor %}
                                    {% endmacro %}
                                    {{ _self.recursiveTabForm(form, ea_crud_form, tab_name) }}
                                {% endif %}
                                {{ block('ea_crud_widget_panels') }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div style="height:240px;"></div>
            </div>
        </div>
    {% else %}
        {{ block('ea_crud_widget_panels') }}
    {% endif %}
{% endblock ea_crud_widget %}

{# motherboard editor #}
{% block _Motherboard_maxcpu_widget %}
{{ form_widget(form)}}
<div style="padding-top:10px;">
    <button id="update-cpu-btn" class="btn btn-secondary" type="button">
        <span class="btn-label"><span class="action-label">Update CPU families</span></span>
    </button>
    <span id="update-cpus-label" style="text-wrap:nowrap;"></span>
</div>
{% endblock _Motherboard_maxcpu_widget %}
{% block _Motherboard_chipset_widget %}
<div style="padding:10px 0px;">
    <button id="update-chipset-btn" class="btn btn-secondary" type="button">
        <span class="btn-label" style="text-wrap:nowrap;"><i class="fa fa-external-link"></i> <span class="action-label">Read expansion chips</span></span>
    </button>
    <button id="reset-chipset-btn" class="btn btn-secondary" type="button">
        <span class="btn-label" style="text-wrap:nowrap;"><i class="fa fa-refresh"></i> <span class="action-label">Reset</span></span>
    </button>
    <button id="update-chips-btn" class="btn btn-secondary" type="button">
        <span class="btn-label" style="text-wrap:nowrap;"><i class="fa fa-refresh"></i> <span class="action-label">Set chips</span></span>
    </button>
    <span id="update-chipset-label"></span>
</div>
{{ form_widget(form)}}
{% endblock _Motherboard_chipset_widget %}
{% block _Motherboard_motherboardIoPorts_entry_count_widget %}
    {{ form_widget(form)}}<span>x</span>
{% endblock _Motherboard_motherboardIoPorts_entry_count_widget %}
{% block _Motherboard_motherboardExpansionSlots_entry_count_widget %}
    {{ form_widget(form)}}<span>x</span>
{% endblock _Motherboard_motherboardExpansionSlots_entry_count_widget %}
{% block _Motherboard_motherboardMemoryConnectors_entry_count_widget %}
    {{ form_widget(form)}}<span>x</span>
{% endblock _Motherboard_motherboardMemoryConnectors_entry_count_widget %}
{% block _Motherboard_motherboardBios_widget %}
<div class="bios-bot-csv-box">
    <div>
        <span>CSV input</span>
        <input id="bios-bot-input" type="file">
        <button id="read-file-btn" type="button" class="btn btn-secondary">Get strings</button>
    </div>
    <div>
        <span>Bulk upload</span>
        <input  id="bios-bulk-upload" type="file" multiple="">
        <button id="bulk-upload-btn" type="button" class="btn btn-secondary">Set files</button>
    </div>
    <span id="bios-form-label"></span>
</div>
{{ form_widget(form)}}
{% endblock _Motherboard_motherboardBios_widget %}
{# expansion card editor #}
{% block _ExpansionCard_miscSpecs_widget %}
    {% include 'admin/macros/specs.html.twig' with {'entity': 'card', 'form': form} %}
{% endblock _ExpansionCard_miscSpecs_widget %}
{% block _ExpansionChip_miscSpecs_widget %}
    {% include 'admin/macros/specs.html.twig' with {'entity': '', 'form': form} %}
{% endblock _ExpansionChip_miscSpecs_widget %}
{% block _ExpansionCardType_template_widget %}
    {% include 'admin/macros/specs.html.twig' with {'entity': '', 'form': form} %}
{% endblock _ExpansionCardType_template_widget %}
{% block _ExpansionCard_ioPorts_entry_count_widget %}
    {{ form_widget(form)}}<span>x</span>
{% endblock _ExpansionCard_ioPorts_entry_count_widget %}
{% block _ExpansionCard_expansionCardMemoryConnectors_entry_count_widget %}
    {{ form_widget(form)}}<span>x</span>
{% endblock _ExpansionCard_expansionCardMemoryConnectors_entry_count_widget %}
{% block _ExpansionCard_expansionCardPowerConnectors_entry_count_widget %}
    {{ form_widget(form)}}<span>x</span>
{% endblock _ExpansionCard_expansionCardPowerConnectors_entry_count_widget %}