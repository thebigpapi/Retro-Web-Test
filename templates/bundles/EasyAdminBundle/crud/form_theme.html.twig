{% extends '@!EasyAdmin/crud/form_theme.html.twig' %}

{% block form_end %}
            {% if not render_rest is defined or render_rest %}
                {{ form_rest(form) }}
            {% endif %}
        </div> {# this closes the '<div class="row">' of form_start #}
        dddd
    </form>
{% endblock %}
{# added the flashy triangle #}
{% block form_errors %}
{% if attr.class|default('') == 'global-invalid-feedback'%}
    <div class="editor-errors">
        <img src="{{ absolute_url(asset('build/icons/warning.svg')) }}" alt="warning" width="40" height="40">
        <div>
        {% if errors|length > 0 %}
            {% for error in errors %}
                <div class="{{ attr.class|default('') }} invalid-feedback d-block">{{ error.message }}</div>
            {% endfor %}
        {% endif %}
        </div>
    </div>
{% else %}
    {% if errors|length > 0 %}
        {% for error in errors %}
            <div class="{{ attr.class|default('') }} invalid-feedback d-block">{{ error.message }}</div>
        {% endfor %}
    {% endif %}
{% endif %}
{% endblock form_errors %}
{# relocated add widget button #}
{% block collection_widget %}
    {# the "is iterable" check is needed because if an object implements __toString() and
               returns an empty string, "is empty" returns true even if it's not a collection #}
    {% set isEmptyCollection = value is null or (value is iterable and value is empty) %}
    {% set is_array_field = 'EasyCorp\\Bundle\\EasyAdminBundle\\Field\\ArrayField' == form.vars.ea_crud_form.ea_field.fieldFqcn ?? false %}
    {% if allow_add|default(false) and not disabled %}
        <button type="button" class="btn btn-link field-collection-add-button">
            <i class="fa fa-plus pr-1"></i>
            {{ 'action.add_new_item'|trans({}, 'EasyAdminBundle') }}
        </button>
    {% endif %}
    <div class="ea-form-collection-items">
        {% if isEmptyCollection %}
            {{ block('empty_collection') }}
        {% elseif is_array_field %}
            {{ block('form_widget') }}
        {% else %}
            <div class="accordion">
                {{ block('form_widget') }}
            </div>
        {% endif %}
    </div>

    {% if isEmptyCollection or form.vars.prototype is defined %}
        {% set attr = attr|merge({'data-empty-collection': block('empty_collection') }) %}
    {% endif %}
{% endblock collection_widget %}
{# delete button tweaks, removed accordion #}
{% block collection_entry_row %}
    {% set is_array_field = 'EasyCorp\\Bundle\\EasyAdminBundle\\Field\\ArrayField' == form_parent(form).vars.ea_crud_form.ea_field.fieldFqcn ?? false %}
    {% set is_complex = form_parent(form).vars.ea_crud_form.ea_field.customOptions.get('entryIsComplex') ?? false %}
    {% set allows_deleting_items = form_parent(form).vars.allow_delete|default(false) %}
    {% set render_expanded = form_parent(form).vars.ea_crud_form.ea_field.customOptions.get('renderExpanded') ?? false %}
    {% set delete_item_button %}
        <button type="button" class="btn btn-link btn-link-danger field-collection-delete-button"
                style="position:relative;"
                title="{{ 'action.remove_item'|trans({}, 'EasyAdminBundle') }}">
            <i class="far fa-trash-alt"></i>
        </button>
    {% endset %}
    <div class="field-collection-item {{ is_complex ? 'field-collection-item-complex' }}">
        {% if is_array_field|default(false) %}
            {{ form_widget(form) }}
            {% if allows_deleting_items and not disabled %}
                {{ delete_item_button }}
            {% endif %}
        {% else %}
            <div class="accordion-item">
                <div id="{{ id }}-contents" class="accordion-collapse collapse {{ render_expanded ? 'show' }}">
                    <div class="accordion-body trw">
                        <div class="accordion-body-widget">{{ form_widget(form) }}</div>
                        <div class="accordion-body-delete-btn">{% if allows_deleting_items and not disabled %}
                            {{ delete_item_button }}
                        {% endif %}</div>
                    </div>
                </div>
                <button class="accordion-button {{ render_expanded ? '' : 'collapsed' }}" style="width:0;display:none;" type="button" data-bs-toggle="collapse" data-bs-target="#{{ id }}-contents">
                        <i class="fas fw fa-chevron-right form-collection-item-collapse-marker"></i>
                        {{ value|ea_as_string }}
                </button>
            </div>
        {% endif %}
    </div>
{% endblock collection_entry_row %}
{% block ea_crud_widget %}
    {% if ea_crud_form.form_tabs|length > 0 %}
        <div class="col-12">
            <div class="nav-tabs-custom form-tabs">
                <ul class="nav nav-tabs">
                    {% for tab_name, tab_config in ea_crud_form.form_tabs %}
                        <li class="nav-item">
                            <a class="nav-link {% if tab_config.active %}active{% endif %}" href="#{{ tab_config['id'] }}" id="{{ tab_config['id'] }}-tab" data-bs-toggle="tab">
                                {%- if tab_config.icon|default(false) -%}
                                    <i class="fa-fw {{ tab_config.icon }}"></i>
                                {%- endif -%}
                                {{ tab_config['label']|trans(domain = ea.i18n.translationDomain) }}
                                {%- if tab_config.errors > 0 -%}
                                    <span class="badge badge-danger" title="{{ 'form.tab.error_badge_title'|trans({'%count%': tab_config.errors}, 'EasyAdminBundle') }}">
                                        {{- tab_config.errors -}}
                                    </span>
                                {%- endif -%}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
                <div class="tab-content">
                    {% for tab_name, tab_config in ea_crud_form.form_tabs %}
                        <div id="{{ tab_config['id'] }}" class="tab-pane {% if tab_config.active %}active{% endif %} {{ tab_config['css_class']|default('') }}">
                            {% if tab_config['help']|default(false) %}
                                <div class="content-header-help tab-help">
                                    {{ tab_config['help']|trans(domain = ea.i18n.translationDomain)|raw }}
                                </div>
                            {% endif %}

                            <div class="row">
                                {% if tab_name is defined and tab_name %}
                                    {% macro recursiveTabForm(form, ea_crud_form, tab_name) %}
                                        {% for field in form|filter(field => not ea_crud_form.form_panels|filter((panel_config, form_panel) => form_panel == field.vars.ea_crud_form.form_panel) and ((field.vars.ea_crud_form.form_tab is defined and field.vars.ea_crud_form.form_tab == tab_name) or field.vars.ea_crud_form.form_tabs is defined)) %}
                                            {% if field.vars.ea_crud_form.form_tabs is defined %}
                                                {# If the field is a nested CRUD form then only render its children #}
                                                {{ _self.recursiveTabForm(field, ea_crud_form, tab_name) }}
                                            {% else %}
                                                {# Render all other fields #}
                                                {{ form_row(field) }}
                                            {% endif %}
                                        {% endfor %}
                                    {% endmacro %}
                                    {{ _self.recursiveTabForm(form, ea_crud_form, tab_name) }}
                                    {% if tab_name == 'CPU stuff' %}
                                    <div class="mobo-buttons" data-controller="motherboard--add">
                                        <button class="btn btn-secondary" type="button"data-action="click->motherboard--add#updateProcessors">
                                            <span class="btn-label"><i class="fa fa-external-link"></i> <span class="action-label">Update cpu</span></span>
                                        </button>
                                    </div>
                                    <div id="cpu-wait" style="display:none;">
                                        <span>Please wait :)</span><img src="https://dev.theretroweb.com/build/images/cursor.gif" alt="" height="24" style="vertical-align: middle;">
                                    </div>
                                    <div class="show-cpus"><div>
                                        <div class="cpu-head">
                                            <div><i>Available CPUs</i></div>
                                            <div></div>
                                            <div><i>Selected CPUs</i></div>
                                        </div>
                                        <div class="dual-list-container">
                                            <div class="dual-list-list">
                                                <select id="unchecked_processors" multiple>
                                                </select>
                                            </div>
                                            <div class="dual-list-buttons">
                                                <button id="add-all-cpus" data-action="click->motherboard--add#addAllProcessors"><img src="{{absolute_url(asset('build/icons/add.svg'))}}" alt="+" style="vertical-align: middle;padding-right:2px;" width="20"> All</button>
                                                <button id="add-all-selected-cpus" data-action="click->motherboard--add#addAllSelectedProcessors"><img src="{{absolute_url(asset('build/icons/arrow.svg'))}}" alt=">" style="vertical-align: middle;" width="20"></button>
                                                <button id="remove-all-selected-cpus" data-action="click->motherboard--add#removeAllSelectedProcessors"><img src="{{absolute_url(asset('build/icons/arrow.svg'))}}" alt="<" style="transform: rotate(180deg);vertical-align: middle;" width="20"></button>
                                                <button id="remove-all-cpus" data-action="click->motherboard--add#removeAllProcessors"><img src="{{absolute_url(asset('build/icons/remove.svg'))}}" alt="-" style="vertical-align: middle;padding-right:2px;" width="20"> All</button>
                                            </div>
                                            <div class="dual-list-list">
                                                <select id="checked_processors" multiple>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="cpu-head">
                                            <div><i>Available NPUs</i></div>
                                            <div></div>
                                            <div><i>Selected NPUs</i></div>
                                        </div>
                                        <div class="dual-list-container">
                                            <div class="dual-list-list">
                                                <select id="unchecked_coprocessors" multiple>
                                                </select>
                                            </div>
                                            <div class="dual-list-buttons">
                                                <button id="add-all-npus" data-action="click->motherboard--add#addAllCoprocessors"><img src="{{absolute_url(asset('build/icons/add.svg'))}}" alt="+" style="vertical-align: middle;padding-right:2px;" width="20"> All</button>
                                                <button id="add-all-selected-npus" data-action="click->motherboard--add#addAllSelectedCoprocessors"><img src="{{absolute_url(asset('build/icons/arrow.svg'))}}" alt=">" style="vertical-align: middle;" width="20"></button>
                                                <button id="remove-all-selected-npus" data-action="click->motherboard--add#removeAllSelectedCoprocessors"><img src="{{absolute_url(asset('build/icons/arrow.svg'))}}" alt="<" style="transform: rotate(180deg);vertical-align: middle;" width="20"></button>
                                                <button id="remove-all-npus" data-action="click->motherboard--add#removeAllCoprocessors"><img src="{{absolute_url(asset('build/icons/remove.svg'))}}" alt="-" style="vertical-align: middle;padding-right:2px;" width="20"> All</button>
                                            </div>
                                            <div class="dual-list-list">
                                                <select id="checked_coprocessors" multiple>
                                                </select>
                                            </div>
                                        </div>
                                    </div></div>
                                    {% endif %}
                                {% endif %}
                                {{ block('ea_crud_widget_panels') }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        {{ block('ea_crud_widget_panels') }}
    {% endif %}
{% endblock ea_crud_widget %}
{% block vich_file_widget %}
    <div class="ea-vich-file">
        {% if download_uri|default('') is not empty %}
            {% set file_extension = download_uri|split('.')|last %}
            {% set extension_icons = {
                'gif': 'fa-file-image-o',
                'jpg': 'fa-file-image-o',
                'pdf': 'fa-file-pdf-o',
                'png': 'fa-file-image-o',
                'zip': 'fa-file-archive-o'
            } %}
            <a id="{{ form.file.vars.id }}_link" class="ea-vich-file-name" href="{{ asset_helper is same as(true) ? asset(download_uri) : download_uri }}">
                <i class="fa fa-fw {{ extension_icons[file_extension] ?? 'fa-file-o' }}"></i>
                {%- if download_label|default(false) -%}
                    {{download_uri}}
                {%- else -%}
                    {{ download_uri|split('/')|last ?: 'download'|trans({}, 'VichUploaderBundle') }}
                {%- endif -%}
            </a>
        {% endif %}

        {% set file_upload_js %}
            var newFile = document.getElementById('{{ form.file.vars.id }}').files[0];
            var fileSizeInMegabytes = newFile.size > 1024 * 1024;
            var fileSize = fileSizeInMegabytes ? newFile.size / (1024 * 1024) : newFile.size / 1024;
            document.getElementById('{{ form.file.vars.id }}_new_file_name').innerText = newFile.name + ' (' + fileSize.toFixed(2) + ' ' + (fileSizeInMegabytes ? 'MB' : 'KB') + ')';
        {% endset %}

        <div class="ea-vich-file-actions">
            {# the container element is needed to allow customizing the <input type="file" /> #}
            <div class="btn btn-secondary input-file-container">
                <i class="fa fa-fw fa-upload"></i> {{ 'action.choose_file'|trans({}, 'EasyAdminBundle') }}
                {{ form_widget(form.file, { 'attr': { 'onchange': file_upload_js }, vich: true}) }}
            </div>

            {% if form.delete is defined %}
                {{ form_row(form.delete) }}
            {% endif %}
        </div>
        <div class="small" id="{{ form.file.vars.id }}_new_file_name"></div>
    </div>
{% endblock %}